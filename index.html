<!DOCTYPE html>
<html lang="uz">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LDSLJMZKLF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LDSLJMZKLF');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Universitet Tanlash</title>
    <link rel="stylesheet" href="dashboard.css">
    <style>
      /* Loading Animation */
      .loader-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>
<body>
  <div class="loader-container" id="loader">
    <div class="loader"></div>
  </div>

  <form class="form-container" id="loginForm">
    <h2>Universitet Tanlash Formasi</h2>

    <label class="input-label" for="university">Universitet</label>
    <select id="university" class="select-field" required>
      <option value="">Tanlang</option>
    </select>

    <label class="input-label" for="educationType">Ta’lim turi</label>
    <select id="educationType" class="select-field" required>
      <option value="">Tanlang</option>
      <option value="kunduzgi">Kunduzgi</option>
      <option value="kechki">Kechgi</option>
      <option value="masofaviy_2">Masofaviy</option>
    </select>

    <label class="input-label" for="language">Ta’lim tili</label>
    <select id="language" class="select-field" required>
      <option value="">Tanlang</option>
      <option value="uz">O‘zbek</option>
      <option value="kk">Qaraqalpoq</option>
      <option value="tj">Tojik</option>
      <option value="ru">Rus</option>
    </select>

    <label class="input-label" for="year">O‘quv yili</label>
    <select id="year" class="select-field" required>
      <option value="2024/2025">2024/2025</option>
    </select>

    <button class="submit-btn" type="submit">Yuborish</button>
  </form>

  <div id="error" class="error"></div>
  <div id="result" class="selected-uni-info" style="display: none;">
    <div class="search-container">
      <input type="text" id="searchInput" class="search-field" placeholder="Yo‘nalishni qidirish...">
    </div>
    <div id="directionsContainer"></div>
  </div>

  <script>
    const universitySelect = document.getElementById('university');
    const educationTypeSelect = document.getElementById('educationType');
    const languageSelect = document.getElementById('language');
    const yearSelect = document.getElementById('year');
    const form = document.getElementById('loginForm');
    const errorDiv = document.getElementById('error');
    const resultDiv = document.getElementById('result');
    const loader = document.getElementById('loader');
    const searchInput = document.getElementById('searchInput');
    const directionsContainer = document.getElementById('directionsContainer');

    let universitiesData = [];

    // Mapping for education type display names in collapsible header
    const educationTypeDisplayNames = {
      'kunduzgi': 'Kunduzgi',
      'kechki': 'Kechgi',
      'masofaviy_2': 'Masofaviy'
    };

    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        universitiesData = data;
        const universities = [...new Set(data.map(item => item.universitet))].sort();
        universities.forEach(uni => {
          const option = document.createElement('option');
          option.value = uni;
          option.textContent = uni;
          universitySelect.appendChild(option);
        });
      })
      .catch(err => {
        errorDiv.textContent = "Maʼlumotlarni yuklashda xatolik yuz berdi";
        console.error(err);
      });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      loader.style.display = 'flex';

      // Simulate 1.5s delay for loading animation
      await new Promise(resolve => setTimeout(resolve, 1500));

      const university = universitySelect.value;
      const educationType = educationTypeSelect.value;
      const language = languageSelect.value;
      const year = yearSelect.value;

      loader.style.display = 'none';

      if (university && educationType && language && year) {
        resultDiv.style.display = 'block';
        const filteredDirections = universitiesData.filter(item =>
          item.universitet === university &&
          item.shakl.toLowerCase() === educationType.toLowerCase() &&
          item.til.toLowerCase() === language.toLowerCase()
        );
        directionsContainer.innerHTML = '';
        filteredDirections.forEach(item => {
          const collapsibleContainer = document.createElement('div');
          collapsibleContainer.className = 'collapsible-container';
          collapsibleContainer.innerHTML = `
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
              <span class="collapsible-title">${item.nomi}</span>
              <span class="language-toggle">
                <button class="lang-btn">${educationTypeDisplayNames[item.shakl.toLowerCase()] || item.shakl}</button>
                <button class="lang-btn">${
                  item.til === 'uz' ? 'O‘zbek' :
                  item.til === 'kk' ? 'Qaraqalpoq' :
                  item.til === 'tj' ? 'Tojik' :
                  item.til === 'ru' ? 'Rus' : 'Noma’lum'
                }</button>
              </span>
            </div>
            <div class="collapsible-content" style="display: none;">
              <div class="info-table">
                <div class="info-row">
                  <span class="info-label">Til:</span>
                  <span class="info-value">${item.til || 'Mavjud emas'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Kontrakt ball:</span>
                  <span class="info-value">${item.contract_ball || 'Mavjud emas'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Grant ball:</span>
                  <span class="info-value">${item.grant_ball || 'Kontrakt'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Fan 1:</span>
                  <span class="info-value">${item['1-fan'] || 'Matematika'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Fan 2:</span>
                  <span class="info-value">${item['2-fan'] || 'Fizika'}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Yil:</span>
                  <span class="info-value">${year}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Shifr:</span>
                  <span class="info-value">${item.shifr}</span>
                </div>
              </div>
            </div>
          `;
          directionsContainer.appendChild(collapsibleContainer);
        });
      } else {
        resultDiv.style.display = 'none';
        errorDiv.textContent = "Iltimos, barcha maydonlarni to‘ldiring.";
      }
    });

    // Search functionality
    searchInput.addEventListener('input', () => {
      const searchTerm = searchInput.value.toLowerCase();
      const university = universitySelect.value;
      const educationType = educationTypeSelect.value;
      const language = languageSelect.value;
      directionsContainer.innerHTML = '';
      const filteredDirections = universitiesData.filter(item =>
        item.universitet === university &&
        item.shakl.toLowerCase() === educationType.toLowerCase() &&
        item.til.toLowerCase() === language.toLowerCase() &&
        item.nomi.toLowerCase().includes(searchTerm)
      );
      filteredDirections.forEach(item => {
        const collapsibleContainer = document.createElement('div');
        collapsibleContainer.className = 'collapsible-container';
        collapsibleContainer.innerHTML = `
          <div class="collapsible-header" onclick="toggleCollapsible(this)">
            <span class="collapsible-title">${item.nomi}</span>
            <span class="language-toggle">
              <button class="lang-btn">${educationTypeDisplayNames[item.shakl.toLowerCase()] || item.shakl}</button>
              <button class="lang-btn">${
                item.til === 'uz' ? 'O‘zbek' :
                item.til === 'kk' ? 'Qaraqalpoq' :
                item.til === 'tj' ? 'Tojik' :
                item.til === 'ru' ? 'Rus' : 'Noma’lum'
              }</button>
            </span>
          </div>
          <div class="collapsible-content" style="display: none;">
            <div class="info-table">
              <div class="info-row">
                <span class="info-label">Til:</span>
                <span class="info-value">${item.til || 'Mavjud emas'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Kontrakt ball:</span>
                <span class="info-value">${item.contract_ball || 'Mavjud emas'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Grant ball:</span>
                <span class="info-value">${item.grant_ball || 'Kontrakt'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Fan 1:</span>
                <span class="info-value">${item['1-fan'] || 'Matematika'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Fan 2:</span>
                <span class="info-value">${item['2-fan'] || 'Fizika'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Yil:</span>
                <span class="info-value">${year}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Shifr:</span>
                <span class="info-value">${item.shifr}</span>
              </div>
            </div>
          </div>
        `;
        directionsContainer.appendChild(collapsibleContainer);
      });
    });

    // Toggle collapsible content
    function toggleCollapsible(element) {
      const content = element.nextElementSibling;
      if (content.style.display === 'none') {
        content.style.display = 'block';
      } else {
        content.style.display = 'none';
      }
    }
  </script>
</body>
</html>